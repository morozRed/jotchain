<turbo-frame id="<%= dom_id(link, :form) %>">
  <% form_scope = if link.persisted?
                    link
                  elsif chain&.persisted?
                    [chain, link]
                  else
                    link
                  end %>
  <%= form_with model: form_scope, class: "space-y-5" do |form| %>
    <% if link.errors.present? %>
      <div class="rounded-xl border border-rose-400/30 bg-rose-500/10 p-4 text-sm text-rose-200">
        <p class="font-semibold">We couldn't save this yet:</p>
        <ul class="mt-2 list-inside list-disc space-y-1">
          <% link.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <% if !link.persisted? && !chain&.persisted? %>
      <div class="space-y-2">
        <%= form.label :chain_id, "Chain", class: "block text-xs font-semibold uppercase tracking-wide text-slate-300" %>
        <%= form.collection_select :chain_id, Chain.all, :id, :name, { prompt: "Select a chain" }, class: "block w-full rounded-xl border border-white/10 bg-slate-950/60 px-4 py-3 text-sm text-white focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-400/40" %>
      </div>
    <% end %>

    <div class="grid gap-4 md:grid-cols-3">
      <div class="space-y-2">
        <%= form.label :recorded_on, class: "block text-xs font-semibold uppercase tracking-wide text-slate-300" %>
        <%= form.date_field :recorded_on, class: "block w-full rounded-xl border border-white/10 bg-slate-950/60 px-3 py-2 text-sm text-white focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-400/40" %>
      </div>
      <div class="space-y-2">
        <%= form.label :category, class: "block text-xs font-semibold uppercase tracking-wide text-slate-300" %>
        <%= form.select :category, options_for_select(Link.categories.keys.map { |key| [key.titleize, key] }, link.category), {}, class: "block w-full rounded-xl border border-white/10 bg-slate-950/60 px-3 py-2 text-sm text-white focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-400/40" %>
      </div>
      <div class="space-y-2">
        <%= form.label :sentiment, class: "block text-xs font-semibold uppercase tracking-wide text-slate-300" %>
        <%= form.select :sentiment, options_for_select(Link.sentiments.keys.map { |key| [key.titleize, key] }, link.sentiment), {}, class: "block w-full rounded-xl border border-white/10 bg-slate-950/60 px-3 py-2 text-sm text-white focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-400/40" %>
      </div>
    </div>

    <div class="space-y-2">
      <%= form.label :title, class: "block text-xs font-semibold uppercase tracking-wide text-slate-300" %>
      <%= form.text_field :title, placeholder: "Headline (optional)", class: "block w-full rounded-xl border border-white/10 bg-slate-950/60 px-4 py-3 text-sm text-white placeholder:text-slate-500 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-400/40" %>
    </div>

    <div class="space-y-2">
      <%= form.label :body, "Details", class: "block text-xs font-semibold uppercase tracking-wide text-slate-300" %>
      <%= form.text_area :body, rows: 6, placeholder: "Capture the highlight, context, and outcome.", class: "block w-full rounded-2xl border border-white/10 bg-slate-950/60 px-4 py-3 text-sm text-white placeholder:text-slate-500 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-400/40" %>
    </div>

    <div class="grid gap-4 md:grid-cols-2">
      <div class="space-y-2">
        <%= form.label :tag_list, "Tags", class: "block text-xs font-semibold uppercase tracking-wide text-slate-300" %>
        <%= form.text_field :tag_list, value: link.tag_list, placeholder: "Leadership, Launch, Customer Win", class: "block w-full rounded-xl border border-white/10 bg-slate-950/60 px-4 py-3 text-sm text-white placeholder:text-slate-500 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-400/40" %>
        <p class="text-[0.7rem] text-slate-500">Comma separated. We’ll split into individual tags.</p>
      </div>
      <div class="space-y-2">
        <%= form.label :mention_list, "Mentions", class: "block text-xs font-semibold uppercase tracking-wide text-slate-300" %>
        <%= form.text_field :mention_list, value: link.mention_list, placeholder: "Andrew Chen, Exec Staff", class: "block w-full rounded-xl border border-white/10 bg-slate-950/60 px-4 py-3 text-sm text-white placeholder:text-slate-500 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-400/40" %>
      </div>
    </div>

    <% other_chains = chain&.persisted? ? chain.space.chains.where.not(id: chain.id) : [] %>
    <% if other_chains.any? %>
      <div class="space-y-2">
        <div class="flex items-center gap-2">
          <svg class="h-4 w-4 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
          </svg>
          <%= form.label :linked_chain_ids, "Connect to other chains", class: "block text-xs font-semibold uppercase tracking-wide text-indigo-300" %>
        </div>
        <%= form.collection_select :linked_chain_ids, other_chains, :id, :name, { selected: link.linked_chain_ids }, multiple: true, class: "block w-full min-h-[120px] rounded-xl border-2 border-indigo-400/30 bg-indigo-950/30 px-4 py-3 text-sm text-white shadow-lg shadow-indigo-500/10 transition focus:border-indigo-400 focus:bg-indigo-950/50 focus:outline-none focus:ring-4 focus:ring-indigo-400/20" %>
        <div class="flex items-start gap-2 rounded-lg bg-indigo-500/10 p-3">
          <svg class="h-4 w-4 text-indigo-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <p class="text-xs text-indigo-200">Hold <kbd class="rounded bg-indigo-500/20 px-1.5 py-0.5 font-mono text-[0.65rem] font-semibold">⌘</kbd> or <kbd class="rounded bg-indigo-500/20 px-1.5 py-0.5 font-mono text-[0.65rem] font-semibold">Ctrl</kbd> to select multiple chains. This builds the graph for future insights.</p>
        </div>
      </div>
    <% end %>

    <%= form.submit link.persisted? ? "Update note" : "Log note", class: "w-full rounded-xl bg-indigo-500 px-4 py-3 text-sm font-semibold text-slate-950 shadow-sm hover:bg-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-300 focus:ring-offset-2 focus:ring-offset-slate-950" %>
  <% end %>
</turbo-frame>
