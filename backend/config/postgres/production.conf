# PostgreSQL Configuration for Waytale Production (2GB RAM, 40GB Storage)
# Optimized for PostGIS 16 on a small VPS
# Generated for Kamal deployment

# =============================================================================
# MEMORY SETTINGS
# =============================================================================

# Shared memory for caching (25% of RAM = 512MB)
shared_buffers = 512MB

# Memory for each query operation (keep low for many connections)
work_mem = 2MB

# Memory for maintenance operations (VACUUM, CREATE INDEX, etc.)
maintenance_work_mem = 128MB

# Stack depth (Linux default is usually fine)
max_stack_depth = 2MB

# Effective cache size hint for query planner (75% of RAM)
effective_cache_size = 1536MB

# =============================================================================
# CONNECTION SETTINGS
# =============================================================================

# Maximum connections (aligned with Rails pool settings)
# Web servers: 2 servers × 2 workers × 25 threads = 100
# Sidekiq: 10 connections
# Admin/maintenance: 10
# Total: 120
max_connections = 120

# Reserved connections for superuser
superuser_reserved_connections = 3

# =============================================================================
# CHECKPOINT SETTINGS
# =============================================================================

# Maximum time between checkpoints
checkpoint_timeout = 15min

# Target for checkpoint completion
checkpoint_completion_target = 0.9

# Maximum WAL size between checkpoints
max_wal_size = 1GB
min_wal_size = 80MB

# =============================================================================
# WRITE AHEAD LOG
# =============================================================================

# WAL level for replication and backup
wal_level = replica

# Compression for full page writes
wal_compression = on

# WAL buffers (auto-tuned, but setting explicitly)
wal_buffers = 16MB

# =============================================================================
# AUTOVACUUM SETTINGS (Critical for 40GB limit)
# =============================================================================

# Enable autovacuum (NEVER disable this!)
autovacuum = on

# Start autovacuum when this many tuples are updated/deleted
autovacuum_vacuum_threshold = 50

# Start autovacuum when this fraction of table is updated/deleted
autovacuum_vacuum_scale_factor = 0.1

# Start analyze when this many tuples are inserted/updated/deleted
autovacuum_analyze_threshold = 50

# Start analyze when this fraction of table is inserted/updated/deleted
autovacuum_analyze_scale_factor = 0.05

# Maximum number of autovacuum workers
autovacuum_max_workers = 3

# Time to sleep between autovacuum runs
autovacuum_naptime = 30s

# Maximum execution time for autovacuum
autovacuum_vacuum_cost_limit = 400

# Aggressively clean up to prevent wraparound
autovacuum_vacuum_insert_threshold = 1000
autovacuum_vacuum_insert_scale_factor = 0.01

# Freeze tuples aggressively to prevent transaction ID wraparound
autovacuum_freeze_max_age = 200000000
autovacuum_multixact_freeze_max_age = 400000000

# =============================================================================
# POSTGIS SPECIFIC
# =============================================================================

# Enable parallel queries for PostGIS operations
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_parallel_maintenance_workers = 2

# =============================================================================
# QUERY TUNING
# =============================================================================

# Random page cost (SSD optimized)
random_page_cost = 1.1

# CPU costs
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025

# Enable query optimization
enable_partitionwise_join = on
enable_partitionwise_aggregate = on

# =============================================================================
# LOGGING AND MONITORING
# =============================================================================

# Log slow queries
log_min_duration_statement = 1000  # Log queries slower than 1 second

# Log autovacuum actions taking more than 1 minute
log_autovacuum_min_duration = 60000

# Log checkpoints
log_checkpoints = on

# Log connections and disconnections
log_connections = on
log_disconnections = on

# Log lock waits longer than 1 second
log_lock_waits = on
deadlock_timeout = 1s

# Statement statistics
track_activities = on
track_counts = on
track_io_timing = on
track_wal_io_timing = on
track_functions = all

# Enable pg_stat_statements extension for query analysis
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.track = all
pg_stat_statements.max = 10000

# =============================================================================
# BACKGROUND WRITER
# =============================================================================

# More aggressive background writing to smooth out I/O
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 200
bgwriter_lru_multiplier = 4.0

# =============================================================================
# CLIENT CONNECTION DEFAULTS
# =============================================================================

# Timezone
timezone = 'UTC'

# Locale settings
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'

# Default text search config
default_text_search_config = 'pg_catalog.english'

# =============================================================================
# LOCK MANAGEMENT
# =============================================================================

# Increase lock table size to prevent lock table overflow
max_locks_per_transaction = 128
max_pred_locks_per_transaction = 128

# =============================================================================
# ERROR HANDLING
# =============================================================================

# Exit on unrecoverable errors
exit_on_error = off
restart_after_crash = on

# =============================================================================
# RESOURCE LIMITS (Prevent runaway queries)
# =============================================================================

# Limit temporary file space (5GB max for sorts, hashes, etc.)
temp_file_limit = 5GB

# Statement timeout (30 minutes max for any single query)
statement_timeout = 1800000  # 30 minutes in milliseconds

# Idle transaction timeout (5 minutes)
idle_in_transaction_session_timeout = 300000  # 5 minutes
